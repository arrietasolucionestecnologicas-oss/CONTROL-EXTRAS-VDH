<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Diagn√≥stico VDH</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>body{background:#222;color:#fff;padding:50px;font-family:monospace;}</style>
</head>
<body>
    <div class="container">
        <h2 class="text-warning">üïµÔ∏è DIAGN√ìSTICO DE CONEXI√ìN VDH</h2>
        
        <div class="mb-3 mt-4">
            <label>1. PEGA TU URL DE APPS SCRIPT AQU√ç:</label>
            <input type="text" id="url-api" class="form-control" placeholder="https://script.google.com/.../exec">
        </div>

        <div class="d-grid gap-2">
            <button onclick="probarGET()" class="btn btn-info">2. PROBAR ACCESO NAVEGADOR (GET)</button>
            <button onclick="probarPOST()" class="btn btn-success">3. PROBAR ENV√çO DATOS (POST)</button>
        </div>

        <div class="mt-4 p-3 border rounded bg-dark">
            <h5>RESULTADO:</h5>
            <pre id="consola" class="text-info">Esperando prueba...</pre>
        </div>
    </div>

    <script>
        function log(txt, color="white") {
            const c = document.getElementById('consola');
            c.style.color = color;
            c.innerText = txt;
        }

        async function probarGET() {
            const url = document.getElementById('url-api').value;
            if(!url) return log("Falta la URL", "red");
            log("Intentando conexi√≥n GET...");
            
            try {
                // Usamos no-cors para probar si al menos llega, aunque no lea respuesta en GET simple
                const r = await fetch(url); 
                const t = await r.text();
                log("‚úÖ GET EXITOSO:\n" + t, "#0f0");
            } catch(e) {
                log("‚ùå FALLO GET:\n" + e.message + "\n\nCausa: URL mal copiada o Permisos mal configurados.", "red");
            }
        }

        async function probarPOST() {
            const url = document.getElementById('url-api').value;
            if(!url) return log("Falta la URL", "red");
            log("Intentando conexi√≥n POST (Env√≠o de datos)...");

            const datos = JSON.stringify({ action: "test_ping", payload: { hola: "mundo" } });

            try {
                const r = await fetch(url, {
                    method: "POST",
                    body: datos
                    // NOTA: No enviamos headers para evitar el Preflight estricto
                });
                
                if(!r.ok) throw new Error("Error HTTP: " + r.status);
                
                const t = await r.text();
                log("‚úÖ POST EXITOSO (CONEXI√ìN TOTAL):\n" + t, "#0f0");
            } catch(e) {
                log("‚ùå FALLO POST:\n" + e.message + "\n\nSi el GET funcion√≥ pero este no, es un bloqueo CORS estricto. \nGoogle requiere 'text/plain' a veces.", "orange");
                
                // Intento alternativo
                log("Reintentando con modo TEXT/PLAIN...", "yellow");
                probarPostBlindado(url, datos);
            }
        }

        async function probarPostBlindado(url, datos) {
            try {
                const r = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: datos
                });
                const t = await r.text();
                log("‚úÖ POST BLINDADO EXITOSO:\n" + t, "#0f0");
            } catch(e) {
                log("‚ò†Ô∏è MUERTE TOTAL:\n" + e.message + "\n\nRevisa:\n1. 'Nueva Versi√≥n' creada.\n2. Acceso: 'Cualquier persona'.\n3. Ejecutar como: 'Yo'.", "red");
            }
        }
    </script>
</body>
</html>
